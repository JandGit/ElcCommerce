package com.android.tkengine.elccommerce.utils;import android.content.Context;import android.content.Intent;import android.graphics.drawable.ColorDrawable;import android.os.Handler;import android.os.Message;import android.support.v7.app.AppCompatActivity;import android.util.Log;import android.view.LayoutInflater;import android.view.MotionEvent;import android.view.View;import android.view.WindowManager;import android.widget.EditText;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.PopupWindow;import android.widget.TextView;import com.android.tkengine.elccommerce.R;import com.android.tkengine.elccommerce.UI.PayActivity;import com.android.tkengine.elccommerce.beans.GoodsBean;import com.android.tkengine.elccommerce.model.ElcModel;import com.android.tkengine.elccommerce.presenter.DisplayPresenter;import org.json.JSONObject;import java.util.Timer;import java.util.TimerTask;/** * Created by FangYu on 2016/8/11. */public class AddCartPopupWindow extends PopupWindow {    private static final String TAG = "AddCartPopupWindow" ;    private View mView;    public ImageView close;    TextView sub, add, sure;    EditText number;    private static final int ADD_SUCCESS = 1;    private static final int ADD_UNSUCCESS = 2;    Handler handlerDelay = new Handler();    public  AddCartPopupWindow (final AppCompatActivity context, View.OnClickListener itemsOnClick, int type){        super(context);        LayoutInflater inflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);        mView = inflater.inflate(R.layout.add_cart, null);        close = (ImageView) mView.findViewById(R.id.add_cart_close);        sub = (TextView) mView.findViewById(R.id.add_cart_sub);        add = (TextView) mView.findViewById(R.id.add_cart_add);        number = (EditText) mView.findViewById(R.id.add_cart_number);        sure = (TextView) mView.findViewById(R.id.add_cart_sure);        final Handler handler = new Handler(){            @Override            public void handleMessage(Message msg) {                switch (msg.what){                    case ADD_SUCCESS:                        final LinearLayout ll = (LinearLayout) context.findViewById(R.id.add_cart_true);                        ll.setVisibility(View.VISIBLE);                        handlerDelay.postDelayed(new Runnable() {                            @Override                            public void run() {                                ll.setVisibility(View.GONE);                            }                        },2000);                        break;                    case ADD_UNSUCCESS:                        final LinearLayout ll2 = (LinearLayout) context.findViewById(R.id.add_cart_false);                        ll2.setVisibility(View.VISIBLE);                        Timer timer2 = new Timer(); //每一个Timer对象对应的是一个线程                        TimerTask timerTask2 = new TimerTask() {                            @Override                            public void run() {                                ll2.setVisibility(View.GONE);                            }                        };                        //在3秒延迟后执行跳转页面                        timer2.schedule(timerTask2, 1000*2);                        break;                    default:                        break;                }}};        close.setOnClickListener(itemsOnClick);       this.setContentView(mView);        this.setWidth(WindowManager.LayoutParams.MATCH_PARENT);        this.setHeight(WindowManager.LayoutParams.WRAP_CONTENT);        this.setFocusable(true);        ColorDrawable dw = new ColorDrawable(0xb0000000);        this.setBackgroundDrawable(dw);        sub.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                int i = Integer.parseInt(number.getText().toString()) ;                if(i>1){                    number.setText((i - 1)+"");                }            }        });        add.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                int i = Integer.parseInt(number.getText().toString()) + 1;                number.setText(i+"");            }        });        switch (type){            case 1:                sure.setOnClickListener(new View.OnClickListener() {                    @Override                    public void onClick(View view) {                        sentRequest();                        dismiss();                    }                    private void sentRequest() {                        new Thread(new Runnable() {                            @Override                            public void run() {                                try{                                    boolean result  = new ElcModel(context).addInCart(context.getIntent().getStringExtra("productID"), number.getText().toString());                                    if(result == true){                                        Message message = new Message();                                        message.what = ADD_SUCCESS;                                        handler.sendMessage(message);                                    }else {                                        Message message = new Message();                                        message.what = ADD_UNSUCCESS;                                        handler.sendMessage(message);                                    }                                }catch (Exception e){                                    e.printStackTrace();                                }                            }                        }).start();                    }                });                break;            case 2:                sure.setOnClickListener(new View.OnClickListener() {                    @Override                    public void onClick(View view) {                        Intent intent = new Intent(context, PayActivity.class);                        GoodsBean goodsBean = new GoodsBean();                        DisplayPresenter displayPresenter = new DisplayPresenter();                        goodsBean.setGoodsId(displayPresenter.mData.getProduct_id());                        goodsBean.setGoodsName(displayPresenter.mData.getProduct_name());                        goodsBean.setGoodsNum(Integer.parseInt(number.getText().toString()));                        goodsBean.setGoodsPrice(displayPresenter.mData .getProduct_price());                        intent.putExtra("product",goodsBean);                        context.startActivity(intent);                    }                });                break;        }//        mView.setOnTouchListener(new View.OnTouchListener() {//            @Override//            public boolean onTouch(View view, MotionEvent motionEvent) {//                int height = (int) mView.findViewById(R.id.add_cart_close).getY();//                int y = (int) motionEvent.getY();//                if(motionEvent.getAction() == MotionEvent.ACTION_UP){//                    if (y < height)//                        dismiss();//                }//                return unsuccess;//            }//        });    }}